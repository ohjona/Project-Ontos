#!/bin/bash
# Ontos pre-push hook - enforces session archiving before push
#
# This hook BLOCKS push if no session has been archived since the last push.
# To bypass in emergencies: git push --no-verify
#
# How it works:
# 1. ontos_end_session.py creates .ontos/session_archived marker
# 2. This hook checks for the marker
# 3. If marker exists: allow push, delete marker (one archive = one push)
# 4. If no marker: block push with instructions

MARKER_FILE=".ontos/session_archived"

# Check if marker file exists
if [ -f "$MARKER_FILE" ]; then
    # Marker exists - session was archived, allow push
    echo ""
    echo "✅ Session archived. Proceeding with push..."
    echo ""

    # Delete marker (one archive = one push)
    rm -f "$MARKER_FILE"
    exit 0
fi

# No marker - block push
echo ""
echo "╔════════════════════════════════════════════════════════════╗"
echo "║           ❌ PUSH BLOCKED - NO SESSION ARCHIVED            ║"
echo "╠════════════════════════════════════════════════════════════╣"
echo "║                                                            ║"
echo "║  You must archive your session before pushing.             ║"
echo "║                                                            ║"
echo "║  Run: \"Archive Ontos\" (or ontos_end_session.py)           ║"
echo "║                                                            ║"
echo "║  This ensures your decisions and context are captured      ║"
echo "║  before code leaves your machine.                          ║"
echo "║                                                            ║"
echo "║  Emergency bypass: git push --no-verify                    ║"
echo "║  (Use sparingly - you'll lose context!)                    ║"
echo "║                                                            ║"
echo "╚════════════════════════════════════════════════════════════╝"
echo ""

exit 1
