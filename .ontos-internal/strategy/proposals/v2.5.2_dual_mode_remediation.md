---
id: v2_5_2_dual_mode_remediation
type: strategy
status: active
depends_on: [v2_strategy]
concepts: [architecture, scaffolding, bugfix, dual-mode]
---

# V2.5.2 Proposal: Dual-Mode Remediation Plan

**Date:** 2025-12-17
**Author:** Claude Opus 4.5 (Architect)
**Status:** FINAL - Multi-Model Review Complete
**Severity:** HIGH - Affects all user installations
**Reviews:** See [v2.5.2 Review Synthesis](v2.5.2_review_synthesis.md)

---

## 1. Executive Summary

**Problem:** Ontos v2.x development has been heavily tested in "contributor mode" (Ontos developing itself) but has significant gaps in "user mode" (projects using Ontos). Several features don't work correctly or at all for regular users.

**Impact:** Any project that installs Ontos and runs `ontos_init.py` will have:
- Missing directory structure
- Broken consolidation (wrong paths)
- Missing starter files
- Features that silently fail

**Root Cause:** Dogfooding bias - we develop Ontos using Ontos, so contributor mode is continuously tested while user mode is not.

---

## 2. Mode Architecture Clarification

### 2.1 Two Orthogonal "Mode" Concepts

```
┌─────────────────────────────────────────────────────────────────┐
│              INSTALLATION MODE (who's using Ontos)              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  CONTRIBUTOR MODE                    USER MODE                  │
│  ─────────────────                   ─────────────              │
│  • Ontos developing itself           • Projects using Ontos    │
│  • Scans: .ontos-internal/           • Scans: docs/            │
│  • Detection: mission.md exists      • Detection: no mission.md│
│  • Users: Ontos maintainers          • Users: Everyone else    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│              WORKFLOW MODE (how much friction)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  AUTOMATED          PROMPTED           ADVISORY                 │
│  ──────────         ────────           ────────                 │
│  • Zero friction    • Keep me in loop  • Max flexibility       │
│  • Auto-archive     • Blocks push      • Warnings only         │
│  • Auto-consolidate • Agent reminders  • Manual everything     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

These are ORTHOGONAL:
• A USER can choose any WORKFLOW mode
• A CONTRIBUTOR can choose any WORKFLOW mode
```

### 2.2 Mode Detection

**Current implementation:** `is_ontos_repo()` in `ontos_config_defaults.py`

```python
def is_ontos_repo() -> bool:
    """Detect if we're in the Ontos repository (contributor mode)."""
    marker = os.path.join(PROJECT_ROOT, '.ontos-internal', 'kernel', 'mission.md')
    return os.path.exists(marker)
```

**This is correct** - the detection mechanism works. The problem is what happens AFTER detection.

---

## 3. Problem Statement

### 3.1 Installation Flow (Current - Broken)

```
User installs Ontos:
1. Copy .ontos/ directory to their project     ✅ Works
2. Copy ontos_init.py to their project         ✅ Works
3. Run: python3 ontos_init.py                  ⚠️  INCOMPLETE

What ontos_init.py SHOULD create:
docs/
├── logs/                          ✅ Created
├── strategy/                      ❌ NOT CREATED
│   ├── decision_history.md        ❌ NOT CREATED
│   └── proposals/                 ❌ NOT CREATED
├── archive/                       ❌ NOT CREATED
│   ├── logs/                      ❌ NOT CREATED
│   └── proposals/                 ❌ NOT CREATED
└── reference/
    └── Common_Concepts.md         ❌ NOT CREATED (only template copied)

Result: User runs consolidation → FAILS (no archive dir)
        User runs query → PARTIAL (no decision_history.md)
        User tries proposals → FAILS (no proposals dir)
```

### 3.2 Path Inconsistency

| File | Contributor Mode | User Mode (Current) | Problem |
|------|------------------|---------------------|---------|
| decision_history.md | `.ontos-internal/strategy/decision_history.md` | `docs/decision_history.md` | Different nesting! |
| proposals/ | `.ontos-internal/strategy/proposals/` | N/A | Doesn't exist |
| archive/logs/ | `.ontos-internal/archive/logs/` | `docs/archive/` | Missing subdirs |
| Common_Concepts.md | `.ontos-internal/reference/Common_Concepts.md` | `docs/reference/Common_Concepts.md` | Not created |

### 3.3 Affected Features

| Feature | Version | Contributor | User | Issue |
|---------|---------|-------------|------|-------|
| Consolidation | v2.1 | ✅ Works | ❌ Fails | No archive dir |
| decision_history.md | v2.1 | ✅ Works | ⚠️ Wrong path | Flat vs nested |
| Common_Concepts.md | v2.2 | ✅ Works | ❌ Not created | Scaffolding gap |
| --lint (concepts) | v2.2 | ✅ Works | ⚠️ Fails silently | No concepts file |
| ontos_query.py | v2.3 | ✅ Works | ⚠️ Partial | Missing files |
| ontos_consolidate.py | v2.3 | ✅ Works | ❌ Fails | Path issues |
| proposals/ | v2.5.1 | ✅ Works | ❌ Not created | Scaffolding gap |
| Rejection workflow | v2.6 | Planned | ❌ Will fail | No archive/proposals/ |

---

## 4. Root Cause Analysis

### 4.1 Dogfooding Bias

```
Development cycle:
1. Develop feature in Ontos repo (contributor mode)
2. Test by using feature (contributor mode)
3. Feature works! Ship it.
4. User installs Ontos (user mode)
5. Feature fails silently or crashes

We never step 4-5 because we're always in contributor mode.
```

### 4.2 Incremental Path Helper Growth

Path helpers were added incrementally without consistent structure:

```python
# Some helpers use nested structure
def get_decision_history_path():
    if is_ontos_repo():
        return '.ontos-internal/strategy/decision_history.md'  # Nested
    return 'docs/decision_history.md'  # FLAT - inconsistent!

# Some helpers are consistent
def get_logs_dir():
    if is_ontos_repo():
        return '.ontos-internal/logs'
    return 'docs/logs'  # Consistent!
```

### 4.3 Minimal Scaffolding Philosophy

`ontos_init.py` was designed to be minimal - create only what's immediately needed. But features added later expect directories that were never scaffolded.

---

## 5. Proposed Solution

### 5.1 Design Principle: Mirror Structure

**User mode should mirror contributor mode structure:**

```
CONTRIBUTOR MODE                    USER MODE
────────────────                    ─────────
.ontos-internal/                    docs/
├── kernel/                         ├── kernel/           (optional)
│   └── mission.md                  │   └── mission.md    (optional)
├── strategy/                       ├── strategy/
│   ├── decision_history.md         │   ├── decision_history.md
│   └── proposals/                  │   └── proposals/
├── atom/                           ├── atom/             (optional)
├── logs/                           ├── logs/
├── archive/                        ├── archive/
│   ├── logs/                       │   ├── logs/
│   └── proposals/                  │   └── proposals/
└── reference/                      └── reference/
    └── Common_Concepts.md              └── Common_Concepts.md
```

**Rationale:**
1. One mental model for documentation
2. Path helpers become simpler (just swap root)
3. All examples work for both modes
4. Future features automatically work

### 5.2 Scaffolding Changes

**File:** `ontos_init.py`

```python
def create_directory_structure():
    """Create complete Ontos directory structure for user mode."""

    docs_dir = resolve_config('DOCS_DIR', 'docs')

    # Required directories
    directories = [
        f'{docs_dir}/logs',
        f'{docs_dir}/strategy',
        f'{docs_dir}/strategy/proposals',
        f'{docs_dir}/archive',
        f'{docs_dir}/archive/logs',
        f'{docs_dir}/archive/proposals',
        f'{docs_dir}/reference',
    ]

    for directory in directories:
        path = os.path.join(PROJECT_ROOT, directory)
        if not os.path.exists(path):
            os.makedirs(path)
            print(f"   Created {directory}/")


def create_starter_files():
    """Create starter files for user mode."""

    docs_dir = resolve_config('DOCS_DIR', 'docs')

    # decision_history.md starter
    decision_history = os.path.join(PROJECT_ROOT, docs_dir, 'strategy', 'decision_history.md')
    if not os.path.exists(decision_history):
        with open(decision_history, 'w') as f:
            f.write(DECISION_HISTORY_TEMPLATE)
        print("   Created strategy/decision_history.md")

    # Common_Concepts.md starter
    concepts = os.path.join(PROJECT_ROOT, docs_dir, 'reference', 'Common_Concepts.md')
    if not os.path.exists(concepts):
        with open(concepts, 'w') as f:
            f.write(COMMON_CONCEPTS_TEMPLATE)
        print("   Created reference/Common_Concepts.md")
```

### 5.3 Path Helper Fixes

**File:** `.ontos/scripts/ontos_lib.py`

```python
def get_decision_history_path() -> str:
    """Get decision_history.md path (mode-aware)."""
    try:
        from ontos_config_defaults import PROJECT_ROOT, is_ontos_repo
    except ImportError:
        return 'docs/strategy/decision_history.md'

    if is_ontos_repo():
        return os.path.join(PROJECT_ROOT, '.ontos-internal', 'strategy', 'decision_history.md')

    docs_dir = resolve_config('DOCS_DIR', 'docs')
    return os.path.join(PROJECT_ROOT, docs_dir, 'strategy', 'decision_history.md')
    #                                           ^^^^^^^^^ FIXED: was flat, now nested


def get_proposals_dir() -> str:
    """Get proposals directory path (mode-aware). NEW HELPER."""
    try:
        from ontos_config_defaults import PROJECT_ROOT, is_ontos_repo
    except ImportError:
        return 'docs/strategy/proposals'

    if is_ontos_repo():
        return os.path.join(PROJECT_ROOT, '.ontos-internal', 'strategy', 'proposals')

    docs_dir = resolve_config('DOCS_DIR', 'docs')
    return os.path.join(PROJECT_ROOT, docs_dir, 'strategy', 'proposals')


def get_archive_proposals_dir() -> str:
    """Get archive/proposals directory path (mode-aware). NEW HELPER."""
    try:
        from ontos_config_defaults import PROJECT_ROOT, is_ontos_repo
    except ImportError:
        return 'docs/archive/proposals'

    if is_ontos_repo():
        return os.path.join(PROJECT_ROOT, '.ontos-internal', 'archive', 'proposals')

    docs_dir = resolve_config('DOCS_DIR', 'docs')
    return os.path.join(PROJECT_ROOT, docs_dir, 'archive', 'proposals')


def get_archive_logs_dir() -> str:
    """Get archive/logs directory path (mode-aware). NEW HELPER (per Claude V2 review)."""
    base = get_archive_dir()
    return os.path.join(base, 'logs')
```

> **Note (per Claude V2):** The existing `get_archive_dir()` returns `docs/archive/`, but consolidation needs `docs/archive/logs/`. Added `get_archive_logs_dir()` to avoid hardcoded paths in `ontos_consolidate.py`.

### 5.4 Template Files — Canonical Source (per Codex V2)

> **BLOCKING FIX (Codex V2):** Templates must be loaded from shipped reference files, not inline constants. This prevents drift between user-mode starters and canonical content.

#### 5.4.1 Template Loading Mechanism

**File:** `.ontos/templates/templates.py` (NEW FILE)

```python
"""
Canonical template loader - Single source of truth for all templates.
Prevents drift between user-mode starters and contributor-mode references.
"""
import os

TEMPLATES_DIR = os.path.dirname(os.path.abspath(__file__))

def load_template(name: str) -> str:
    """Load template from shipped reference file."""
    template_path = os.path.join(TEMPLATES_DIR, name)
    if os.path.exists(template_path):
        with open(template_path, 'r') as f:
            return f.read()
    raise FileNotFoundError(f"Template not found: {template_path}")

def get_decision_history_template() -> str:
    """Get decision_history.md template."""
    return load_template('decision_history_template.md')

def get_common_concepts_template() -> str:
    """Get Common_Concepts.md template."""
    return load_template('common_concepts_template.md')
```

#### 5.4.2 Template Files Location

```
.ontos/
├── templates/                              # NEW DIRECTORY
│   ├── templates.py                        # Loader module
│   ├── decision_history_template.md        # Canonical template
│   └── common_concepts_template.md         # Canonical template
```

#### 5.4.3 Updated `create_starter_files()`

```python
def create_starter_files():
    """Create starter files for user mode using canonical templates."""
    from .templates.templates import get_decision_history_template, get_common_concepts_template

    docs_dir = resolve_config('DOCS_DIR', 'docs')

    # decision_history.md starter (from canonical template)
    decision_history = os.path.join(PROJECT_ROOT, docs_dir, 'strategy', 'decision_history.md')
    if not os.path.exists(decision_history):
        with open(decision_history, 'w') as f:
            f.write(get_decision_history_template())
        print("   Created strategy/decision_history.md")

    # Common_Concepts.md starter (from canonical template)
    concepts = os.path.join(PROJECT_ROOT, docs_dir, 'reference', 'Common_Concepts.md')
    if not os.path.exists(concepts):
        with open(concepts, 'w') as f:
            f.write(get_common_concepts_template())
        print("   Created reference/Common_Concepts.md")
```

#### 5.4.4 Template Content

**`.ontos/templates/decision_history_template.md`:**

> **Note (per Claude V2):** `depends_on: []` is intentional for user mode. Users should update this after creating their own kernel documents. The validator will flag this as an orphan until connected to the graph.

```markdown
---
id: decision_history
type: strategy
status: active
depends_on: []
---

# Decision History

This document records key decisions made during development, including both approvals and rejections.

## Decision Log

| Date | Slug | Decision | Outcome | Archive Path |
|------|------|----------|---------|--------------|
| | | | | |

## How to Use

- **Consolidation:** Old session logs are summarized here during monthly maintenance
- **Rejections:** Rejected proposals are recorded with REJECTED outcome
- **Historical Recall:** Reference archive paths to understand full context
```

**`.ontos/templates/common_concepts_template.md`:**
```markdown
---
id: common_concepts
type: atom
status: active
depends_on: []
---

# Common Concepts

Controlled vocabulary for consistent tagging across session logs and documents.

## Concept Reference

| Concept | Description |
|---------|-------------|
| `architecture` | System design and structure |
| `bugfix` | Bug fixes and corrections |
| `config` | Configuration management |
| `docs` | Documentation |
| `feature` | New features |
| `performance` | Performance optimization |
| `refactor` | Code refactoring |
| `security` | Security concerns |
| `test` | Testing |
| `ux` | User experience |

## Adding New Concepts

Add new concepts as your project evolves. Keep descriptions brief (1 line).
```

---

## 6. Migration Strategy

> **UPDATED per Multi-Model Review Synthesis**

### 6.1 Design Principles (from Review)

Per Gemini's recommendation, adopted by synthesis:
- **Do NOT create separate `ontos_migrate_structure.py`**
- **Make `ontos_init.py` idempotent** — safe to run multiple times
- **User mental model:** "Run `ontos_init.py` to fix anything"

### 6.2 New Installations

New users running `ontos_init.py` will get the complete structure automatically.

### 6.3 Existing User Installations (v2.5.2 — Conservative)

Per Claude V2's recommendation: Patch releases shouldn't move files.

**v2.5.2 Behavior:**
1. AUTO-CREATE missing directories (safe, additive)
2. WARN about old file locations (don't move yet)
3. Provide clear migration instructions

```python
# In ontos_init.py - v2.5.2 conservative migration
def migrate_structure():
    """Create missing directories, warn about old paths. Idempotent."""
    docs_dir = resolve_config('DOCS_DIR', 'docs')

    # 1. Create all required directories (safe)
    create_directory_structure()

    # 2. Warn about old file locations (don't move)
    old_decision = os.path.join(docs_dir, 'decision_history.md')
    new_decision = os.path.join(docs_dir, 'strategy', 'decision_history.md')

    if os.path.exists(old_decision) and not os.path.exists(new_decision):
        print("[DEPRECATION WARNING] Found 'docs/decision_history.md' in old location.")
        print("   Recommended: mv docs/decision_history.md docs/strategy/")
        print("   This file will be auto-migrated in v2.6.0")

    # 3. Create starter files if missing
    create_starter_files()
```

**v2.6.0 Behavior (Future):**
1. AUTO-MIGRATE files with informative output (Gemini's suggestion)
2. No prompts (script-safe)

```
# Example v2.6.0 output
Initializing Ontos project...
[OK] 'docs/logs' directory exists.
[MIGRATED] Moved 'docs/decision_history.md' to 'docs/strategy/decision_history.md'.
[CREATED] 'docs/archive/proposals' directory.
Project structure is up to date.
```

### 6.4 Backward Compatibility — Complete Implementation (per Codex V2)

> **BLOCKING FIX (Codex V2):** Backward compat must cover ALL paths, not just `decision_history.md`. Pre-v2.5.2 installs will fail consolidation/query without these fallbacks.

Path helpers check both locations during transition, with deprecation warnings:

#### 6.4.1 `get_decision_history_path()` — with backward compat

```python
def get_decision_history_path() -> str:
    """Get decision_history.md path with backward compatibility."""
    if is_ontos_repo():
        return os.path.join(PROJECT_ROOT, '.ontos-internal', 'strategy', 'decision_history.md')

    docs_dir = resolve_config('DOCS_DIR', 'docs')

    # Try new location first (v2.5.2+)
    new_path = os.path.join(PROJECT_ROOT, docs_dir, 'strategy', 'decision_history.md')
    if os.path.exists(new_path):
        return new_path

    # Fall back to old location (pre-v2.5.2)
    old_path = os.path.join(PROJECT_ROOT, docs_dir, 'decision_history.md')
    if os.path.exists(old_path):
        _warn_deprecated('docs/decision_history.md', 'docs/strategy/decision_history.md')
        return old_path

    # Return new location for creation
    return new_path
```

#### 6.4.2 `get_archive_logs_dir()` — with backward compat (NEW)

```python
def get_archive_logs_dir() -> str:
    """Get archive/logs directory path with backward compatibility."""
    if is_ontos_repo():
        return os.path.join(PROJECT_ROOT, '.ontos-internal', 'archive', 'logs')

    docs_dir = resolve_config('DOCS_DIR', 'docs')

    # Try new location first (v2.5.2+)
    new_path = os.path.join(PROJECT_ROOT, docs_dir, 'archive', 'logs')
    if os.path.exists(new_path):
        return new_path

    # Fall back to old location (pre-v2.5.2: logs directly in archive/)
    old_path = os.path.join(PROJECT_ROOT, docs_dir, 'archive')
    if os.path.exists(old_path):
        # Check if old structure (logs directly in archive, not in archive/logs)
        _warn_deprecated('docs/archive/', 'docs/archive/logs/')
        return old_path

    # Return new location for creation
    return new_path
```

#### 6.4.3 `get_archive_proposals_dir()` — with backward compat (NEW)

```python
def get_archive_proposals_dir() -> str:
    """Get archive/proposals directory path with backward compatibility."""
    if is_ontos_repo():
        return os.path.join(PROJECT_ROOT, '.ontos-internal', 'archive', 'proposals')

    docs_dir = resolve_config('DOCS_DIR', 'docs')

    # Try new location first (v2.5.2+)
    new_path = os.path.join(PROJECT_ROOT, docs_dir, 'archive', 'proposals')
    if os.path.exists(new_path):
        return new_path

    # No old location for proposals (new in v2.5.2)
    # Return new location for creation
    return new_path
```

#### 6.4.4 `get_concepts_path()` — with backward compat (NEW)

```python
def get_concepts_path() -> str:
    """Get Common_Concepts.md path with backward compatibility."""
    if is_ontos_repo():
        return os.path.join(PROJECT_ROOT, '.ontos-internal', 'reference', 'Common_Concepts.md')

    docs_dir = resolve_config('DOCS_DIR', 'docs')

    # Try new location first (v2.5.2+)
    new_path = os.path.join(PROJECT_ROOT, docs_dir, 'reference', 'Common_Concepts.md')
    if os.path.exists(new_path):
        return new_path

    # Fall back to old location (pre-v2.5.2: directly in docs/)
    old_path = os.path.join(PROJECT_ROOT, docs_dir, 'Common_Concepts.md')
    if os.path.exists(old_path):
        _warn_deprecated('docs/Common_Concepts.md', 'docs/reference/Common_Concepts.md')
        return old_path

    # Return new location for creation
    return new_path
```

#### 6.4.5 Deprecation Warning Helper

```python
_deprecation_warned = set()  # Track warnings to avoid spam

def _warn_deprecated(old_path: str, new_path: str):
    """Issue deprecation warning (once per path per session)."""
    if old_path in _deprecation_warned:
        return
    _deprecation_warned.add(old_path)
    print(f"[DEPRECATION WARNING] Using old path '{old_path}'.")
    print(f"   Expected: '{new_path}'")
    print("   Run 'python3 ontos_init.py' to update your project structure.")
```

#### 6.4.6 Migration Warning in `ontos_init.py`

```python
def check_and_warn_old_paths():
    """Check for files in old locations and warn user."""
    docs_dir = resolve_config('DOCS_DIR', 'docs')

    old_paths = [
        (f'{docs_dir}/decision_history.md', f'{docs_dir}/strategy/decision_history.md'),
        (f'{docs_dir}/Common_Concepts.md', f'{docs_dir}/reference/Common_Concepts.md'),
    ]

    for old, new in old_paths:
        old_full = os.path.join(PROJECT_ROOT, old)
        new_full = os.path.join(PROJECT_ROOT, new)
        if os.path.exists(old_full) and not os.path.exists(new_full):
            print(f"[DEPRECATION WARNING] Found '{old}' in old location.")
            print(f"   Recommended: mv {old} {new}")
            print("   This file will be auto-migrated in v2.6.0")
```

**Backward-compat coverage (per Codex V2):**
- ✅ `get_decision_history_path()` — checks `docs/decision_history.md`
- ✅ `get_archive_logs_dir()` — checks `docs/archive/`
- ✅ `get_archive_proposals_dir()` — new in v2.5.2, no old path
- ✅ `get_concepts_path()` — checks `docs/Common_Concepts.md`

**Debt removal scheduled:** TODO for v2.7 — remove backward-compat code after transition period.

---

## 7. Testing Strategy

> **UPDATED per Multi-Model Review Synthesis**

### 7.1 User Mode Test Fixture (Hardened per Codex)

Create a test fixture that simulates user installation. **Fixed issues:**
- Use `check=True` to fail on errors (per Codex)
- Use absolute paths via `PROJECT_ROOT` (per Codex)
- Explicit assertions on all expected paths (per Codex)

```python
@pytest.fixture
def user_mode_project(tmp_path):
    """Create a fresh user-mode Ontos installation."""
    import os

    # Use absolute paths (per Codex - fixture brittleness fix)
    project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

    # Copy .ontos/ scripts (simulates user copying from GitHub)
    shutil.copytree(os.path.join(project_root, '.ontos'), tmp_path / '.ontos')
    shutil.copy(os.path.join(project_root, 'ontos_init.py'), tmp_path)

    # Run init (simulates user running ontos_init.py)
    # FIXED: use check=True to fail on errors (per Codex)
    result = subprocess.run(
        [sys.executable, 'ontos_init.py', '--non-interactive'],
        cwd=tmp_path,
        check=True,  # ADDED: fail test if init fails
        capture_output=True,
        text=True
    )

    # Explicit assertions on ALL expected directories (per Codex)
    assert (tmp_path / 'docs' / 'logs').exists(), "Missing docs/logs/"
    assert (tmp_path / 'docs' / 'strategy').exists(), "Missing docs/strategy/"
    assert (tmp_path / 'docs' / 'strategy' / 'proposals').exists(), "Missing docs/strategy/proposals/"
    assert (tmp_path / 'docs' / 'archive').exists(), "Missing docs/archive/"
    assert (tmp_path / 'docs' / 'archive' / 'logs').exists(), "Missing docs/archive/logs/"
    assert (tmp_path / 'docs' / 'archive' / 'proposals').exists(), "Missing docs/archive/proposals/"
    assert (tmp_path / 'docs' / 'reference').exists(), "Missing docs/reference/"

    # Explicit assertions on starter files
    assert (tmp_path / 'docs' / 'strategy' / 'decision_history.md').exists(), "Missing decision_history.md"
    assert (tmp_path / 'docs' / 'reference' / 'Common_Concepts.md').exists(), "Missing Common_Concepts.md"

    return tmp_path
```

### 7.2 End-to-End Workflow Test (per Claude V2)

```python
def test_full_user_workflow(user_mode_project):
    """
    End-to-end workflow test (per Claude V2).
    Runs: init → create doc → create session → archive → consolidate
    """
    tmp_path = user_mode_project

    # 1. Create a session log
    log_dir = tmp_path / 'docs' / 'logs'
    session_log = log_dir / '2025-01-01_test-session.md'
    session_log.write_text('''---
id: test_session
type: log
status: active
depends_on: []
concepts: [test, workflow]
---

# Test Session

Some content.
''')
    assert session_log.exists()

    # 2. Run consolidation (should work in user mode)
    result = subprocess.run(
        [sys.executable, '-m', 'ontos.scripts.ontos_consolidate', '--dry-run'],
        cwd=tmp_path,
        check=True,
        capture_output=True,
        text=True
    )
    # Verify no errors
    assert result.returncode == 0

    # 3. Verify archive paths exist
    assert (tmp_path / 'docs' / 'archive' / 'logs').exists()

    # 4. Verify decision_history is accessible
    decision_history = tmp_path / 'docs' / 'strategy' / 'decision_history.md'
    assert decision_history.exists()
```

### 7.3 Dual-Mode Test Decorator

```python
@pytest.mark.parametrize("mode", ["contributor", "user"])
def test_consolidation_works_in_both_modes(mode, tmp_path):
    """Consolidation should work identically in both modes."""

    if mode == "contributor":
        setup_contributor_mode(tmp_path)
    else:
        setup_user_mode(tmp_path)

    # Create some logs
    create_test_logs(tmp_path, count=20)

    # Run consolidation
    result = run_consolidation(tmp_path)

    # Verify
    assert result.returncode == 0
    assert archive_has_logs(tmp_path)
    assert decision_history_updated(tmp_path)
```

### 7.4 Test Coverage Requirements

> **UPDATED per Multi-Model Review Synthesis**

| Feature | Contributor Test | User Test | Status |
|---------|------------------|-----------|--------|
| ontos_init.py scaffolding | N/A | Required | NEW |
| ontos_consolidate.py | Exists | Required | NEW |
| ontos_query.py | Exists | Required | NEW |
| ontos_end_session.py | Exists | Required | NEW |
| ontos_maintain.py | Exists | Required | NEW |
| Pre-commit hook | Exists | Required | NEW |
| Pre-push hook | Exists | Required | NEW |
| Context map generation | Exists | Required | NEW |
| Path helpers | Exists | Required | NEW |
| **Path helpers with DOCS_DIR override** | N/A | **Required** | NEW (per Claude V2) |
| **End-to-end workflow** | N/A | **Required** | NEW (per Claude V2) |

### 7.5 CI Enforcement — Complete Implementation (per Codex V2)

> **BLOCKING FIX (Codex V2):** CI matrix uses `--mode` flag but pytest doesn't have this natively. Must add `conftest.py` to consume the flag.

#### 7.5.1 `conftest.py` — Mode Selection Hook (REQUIRED)

**File:** `tests/conftest.py`

```python
"""
Pytest configuration for dual-mode testing.
Allows running tests in 'contributor' or 'user' mode via --mode flag.
"""
import pytest
import os
import shutil
import tempfile


def pytest_addoption(parser):
    """Add --mode option to pytest CLI."""
    parser.addoption(
        "--mode",
        action="store",
        default="contributor",
        choices=["contributor", "user"],
        help="Run tests in 'contributor' or 'user' mode"
    )


@pytest.fixture
def project_mode(request):
    """Get the current test mode."""
    return request.config.getoption("--mode")


@pytest.fixture
def mode_aware_project(request, tmp_path):
    """
    Create a project fixture based on the current mode.
    - contributor: Uses .ontos-internal/ structure
    - user: Uses docs/ structure (simulates user installation)
    """
    mode = request.config.getoption("--mode")
    project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

    if mode == "contributor":
        # Contributor mode: copy full project structure
        shutil.copytree(
            os.path.join(project_root, '.ontos-internal'),
            tmp_path / '.ontos-internal'
        )
        shutil.copytree(
            os.path.join(project_root, '.ontos'),
            tmp_path / '.ontos'
        )
    else:
        # User mode: simulate fresh installation
        shutil.copytree(
            os.path.join(project_root, '.ontos'),
            tmp_path / '.ontos'
        )
        shutil.copy(
            os.path.join(project_root, 'ontos_init.py'),
            tmp_path
        )
        # Run init to create user structure
        import subprocess
        import sys
        subprocess.run(
            [sys.executable, 'ontos_init.py', '--non-interactive'],
            cwd=tmp_path,
            check=True,
            capture_output=True
        )

    return tmp_path


@pytest.fixture
def docs_dir(project_mode):
    """Get the docs directory based on mode."""
    if project_mode == "contributor":
        return ".ontos-internal"
    return "docs"
```

#### 7.5.2 CI Workflow Configuration

**File:** `.github/workflows/test.yml`

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Run both modes even if one fails
      matrix:
        mode: [contributor, user]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests in ${{ matrix.mode }} mode
        run: pytest --mode=${{ matrix.mode }} -v

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.mode }}
          path: test-results/
```

#### 7.5.3 Example Dual-Mode Test Usage

```python
def test_decision_history_path(mode_aware_project, docs_dir):
    """Test that decision_history path is correct in both modes."""
    from ontos_lib import get_decision_history_path

    expected = mode_aware_project / docs_dir / 'strategy' / 'decision_history.md'
    actual = get_decision_history_path()

    assert actual == str(expected)
```

**Acceptance criteria:**
- [x] `conftest.py` with `--mode` option defined
- [x] `mode_aware_project` fixture creates correct structure per mode
- [ ] CI runs tests in both contributor and user mode
- [ ] User-mode failures block release
- [ ] Test matrix is visible in PR checks

---

## 8. Documentation Updates

> **UPDATED per Multi-Model Review Synthesis**

### 8.1 Files to Update

| File | Change |
|------|--------|
| `docs/reference/Ontos_Manual.md` | Add directory structure section, clarify modes |
| `docs/reference/Ontos_Manual.md` | **Add "Advanced Usage" section for optional dirs (per Gemini)** |
| `docs/reference/Ontos_Agent_Instructions.md` | Mode-agnostic examples |
| `README.md` | Clarify what gets created on init |
| `CONTRIBUTING.md` | Document dual-mode testing requirement |

### 8.1.1 Advanced Usage Section (per Gemini)

Add to `Ontos_Manual.md`:

```markdown
## Advanced Usage: Optional Directories

By default, Ontos creates only required directories. For advanced features,
you can manually create optional directories:

### kernel/ - Core Project Philosophy
```bash
mkdir -p docs/kernel
touch docs/kernel/mission.md
```
Use `kernel/` to document your project's core mission and values.

### atom/ - Detailed Concept Documents
```bash
mkdir -p docs/atom
```
Use `atom/` for detailed concept exploration documents linked to `Common_Concepts.md`.
```

### 8.2 Example Updates

**Before (contributor-mode assumption):**
```markdown
Decision history is stored in `.ontos-internal/strategy/decision_history.md`
```

**After (mode-agnostic):**
```markdown
Decision history is stored in:
- Contributor mode: `.ontos-internal/strategy/decision_history.md`
- User mode: `docs/strategy/decision_history.md`

The path is resolved automatically by Ontos scripts.
```

---

## 9. Implementation Checklist

> **UPDATED per Round 2 Reviews (Codex V2, Gemini V2, Claude V3)**

### Phase 1: Critical Fixes (v2.5.2) — BLOCKING

**Scaffolding:**
- [ ] Fix `create_directory_structure()` to create all required dirs — *code in Section 5.2*
- [ ] Fix `scaffold_starter_docs()` to respect `DOCS_DIR` config (per Claude V2) — *code in Section 5.4.3*
- [ ] Make `ontos_init.py` idempotent (safe to run multiple times) (per Gemini)
- [ ] Do NOT create separate migration script — use init (per Gemini)

**Path Helpers:**
- [ ] Fix `get_decision_history_path()` — use nested structure — *code in Section 6.4.1*
- [ ] Add `get_proposals_dir()` helper — *code in Section 5.3*
- [ ] Add `get_archive_proposals_dir()` helper — *code in Section 6.4.3*
- [ ] Add `get_archive_logs_dir()` helper (per Claude V2) — *code in Section 6.4.2*
- [ ] Add `get_concepts_path()` helper (per Codex V2) — *code in Section 6.4.4*
- [ ] Add backward-compat fallbacks for ALL paths (per Codex V2) — *code in Section 6.4*
- [ ] Add `_warn_deprecated()` helper (per Gemini) — *code in Section 6.4.5*
- [ ] Add `check_and_warn_old_paths()` in init (per Codex V2) — *code in Section 6.4.6*

**Templates (BLOCKING FIX per Codex V2):**
- [ ] Create `.ontos/templates/` directory — *structure in Section 5.4.2*
- [ ] Create `.ontos/templates/templates.py` loader module — *code in Section 5.4.1*
- [ ] Create `.ontos/templates/decision_history_template.md` — *content in Section 5.4.4*
- [ ] Create `.ontos/templates/common_concepts_template.md` — *content in Section 5.4.4*
- [ ] Update `create_starter_files()` to use template loader — *code in Section 5.4.3*

**Migration (v2.5.2 — Conservative per Claude V2):**
- [ ] AUTO-CREATE missing directories
- [ ] WARN about old file locations (don't move)
- [ ] Provide clear instructions to user

### Phase 2: Testing (v2.5.2)

- [ ] Fix test fixture: use `check=True`, absolute paths, explicit assertions (per Codex) — *code in Section 7.1*
- [ ] Add dual-mode parametrized tests for ALL major scripts — *code in Section 7.3*
- [ ] Add end-to-end workflow test (init → create → archive → consolidate) (per Claude V2) — *code in Section 7.2*
- [ ] Add test: path helpers work with custom DOCS_DIR (per Claude V2)

**CI Infrastructure (BLOCKING FIX per Codex V2):**
- [ ] Create `tests/conftest.py` with `--mode` option — *code in Section 7.5.1*
- [ ] Add `project_mode` fixture — *code in Section 7.5.1*
- [ ] Add `mode_aware_project` fixture — *code in Section 7.5.1*
- [ ] Add `docs_dir` fixture — *code in Section 7.5.1*
- [ ] Update `.github/workflows/test.yml` with matrix strategy — *code in Section 7.5.2*

### Phase 3: Documentation (v2.5.2)

- [ ] Update Manual with directory structure for both modes
- [ ] Add "Advanced Usage" section for optional directories (per Gemini)
- [ ] Add note about `depends_on: []` for user-mode decision_history (per Claude V2)
- [ ] Audit all docs for contributor-mode assumptions
- [ ] Add troubleshooting for "directory not found" errors

### Phase 4: Future (v2.6.0)

- [ ] Implement auto-migration with informative output (per Gemini)
- [ ] Add cleanup TODO for backward-compat code (target: v2.7) (per Gemini)

---

## 10. Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Breaking existing user installations | HIGH | Backward-compatible path helpers, migration script |
| Migration confusion | MEDIUM | Clear upgrade instructions, auto-migration in init |
| Test suite complexity | MEDIUM | Good fixtures, parametrized tests |
| Documentation drift | LOW | Mode-agnostic examples, review process |

---

## 11. Open Questions — Final Resolutions

> **RESOLVED per Multi-Model Review Synthesis**

| Q# | Question | Final Resolution | Rationale |
|----|----------|------------------|-----------|
| Q1 | Nested vs Flat | **Option A: Mirror exactly** | Unanimous — consistency wins |
| Q2 | Auto-Migration | **Hybrid: Create dirs in v2.5.2, migrate files in v2.6** | Balance safety + UX |
| Q3 | Optional Dirs | **Option B: Required only** | Unanimous |
| Q4 | Test Infrastructure | **Option C: Parametrized** | Unanimous |
| Q5 | Error Messages | **Hybrid: Auto-create in init, error in daily scripts** | Claude V2 + Gemini concerns |

### Q1: Nested vs Flat Structure for Users ✅ RESOLVED

**Final Resolution:** Option A — Mirror exactly

**Consensus:** Unanimous (Codex, Claude V2, Gemini)

All reviewers agree consistency is worth the extra directory level. One mental model for everyone.

### Q2: Auto-Migration Behavior ✅ RESOLVED

**Final Resolution:** Hybrid approach

| Version | Behavior |
|---------|----------|
| v2.5.2 (patch) | Auto-create dirs, warn about old files, don't move (per Claude V2) |
| v2.6.0 (minor) | Auto-migrate files with informative output (per Gemini) |

**Rationale:** Patch releases shouldn't move files (Claude V2). Eventually frictionless, no prompts (Gemini).

### Q3: Optional Directories ✅ RESOLVED

**Final Resolution:** Option B — Required only

**Consensus:** Unanimous

Create only: `logs/`, `strategy/`, `strategy/proposals/`, `archive/`, `archive/logs/`, `archive/proposals/`, `reference/`

Document `kernel/` and `atom/` in "Advanced Usage" section (per Gemini).

### Q4: Test Infrastructure ✅ RESOLVED

**Final Resolution:** Option C — Parametrized tests

**Consensus:** Unanimous

Same test logic runs against both "user" and "contributor" mode setups. DRY principle.

### Q5: Error Messages ✅ RESOLVED

**Final Resolution:** Hybrid approach (Claude V2's recommendation)

| Script Type | Behavior |
|-------------|----------|
| `ontos_init.py` | Auto-create missing dirs (smooth setup) |
| Daily scripts (consolidate, query, etc.) | Error with clear instructions |

**Rationale:**
- Init is explicitly a "setup/repair" command — creating is expected
- Daily scripts running from wrong directory should fail loudly (Gemini's concern about wrong-directory pollution is valid)

---

## 12. Approval Checklist

> **UPDATED: Round 2 Reviews Complete**

### Round 1 Reviews

| Reviewer | Status | Date | Notes |
|----------|--------|------|-------|
| V1 Codex | CHANGES REQUIRED → **INCORPORATED** | 2025-12-17 | Implementation bugs found |
| V1 Claude Opus | APPROVED w/ AMENDMENTS → **INCORPORATED** | 2025-12-17 | All amendments incorporated |
| V1 Gemini | APPROVED w/ RECOMMENDATIONS → **INCORPORATED** | 2025-12-17 | All recommendations incorporated |

### Round 2 Reviews

| Reviewer | Status | Date | Notes |
|----------|--------|------|-------|
| V2 Codex | BLOCKING → **ADDRESSED** | 2025-12-17 | Template/compat/CI gaps filled |
| V2 Gemini | **APPROVED** | 2025-12-17 | Full unconditional approval |
| V3 Claude Opus | **APPROVED** | 2025-12-17 | Ready for implementation |

### Final Status

| Reviewer | Final Verdict |
|----------|---------------|
| Claude (Architect) | FINAL — All blocking fixes addressed |
| Codex | R2 concerns addressed — code now in plan |
| Claude Opus | **APPROVED FOR IMPLEMENTATION** |
| Gemini | **APPROVED** (full unconditional) |
| Human (Jonathan) | **PENDING** |

---

## 13. References

**Round 1 Reviews:**
- [V1_Codex_v2.5.2.md](V1_Codex_v2.5.2.md) — Codex R1 (CHANGES REQUIRED)
- [V2_Claude_Opus_v2.5.2_review.md](V2_Claude_Opus_v2.5.2_review.md) — Claude Opus R1 (APPROVED w/ amendments)
- [V1_Gemini_v2.5.2.md](V1_Gemini_v2.5.2.md) — Gemini R1 (APPROVED w/ recommendations)

**Round 2 Reviews:**
- [V2_Codex_v2.5.2.md](V2_Codex_v2.5.2.md) — Codex R2 (BLOCKING findings)
- [V2_Gemini_V2.5.2.md](V2_Gemini_V2.5.2.md) — Gemini R2 (APPROVED)
- [V3_Claude_Opus_v2.5.2_final_review.md](V3_Claude_Opus_v2.5.2_final_review.md) — Claude Opus R2 (APPROVED)

**Synthesis:**
- [v2.5.2_review_synthesis.md](v2.5.2_review_synthesis.md) — Round 1 synthesis

**Related Documents:**
- [Session Log: Proposals Architecture](../../logs/2025-12-17_v2-5-1-proposals-architecture.md)
- [V2.6 Proposals and Tooling](v2.6_proposals_and_tooling.md)

**Source Code:**
- [ontos_init.py](/Users/jonathanoh/Dev/Project-Ontos/ontos_init.py)
- [ontos_lib.py](/Users/jonathanoh/Dev/Project-Ontos/.ontos/scripts/ontos_lib.py)

---

## 14. What We Learned (Process Improvement)

> Added from synthesis document

1. **Multi-model review works** — each reviewer caught different issues
2. **Implementation details matter** — Codex found bugs others missed
3. **UX perspectives vary** — Gemini prioritized frictionless, Claude V2 prioritized safety
4. **Synthesis creates better solutions** — hybrid approaches beat any single position

**For future proposals:**
- Always get 3+ model reviews before implementation
- Explicitly list implementation code snippets for code review
- Include "run this script" verification steps
