---
id: v2_5_2_dual_mode_remediation
type: strategy
status: draft
depends_on: [v2_strategy]
concepts: [architecture, scaffolding, bugfix, dual-mode]
---

# V2.5.2 Proposal: Dual-Mode Remediation Plan

**Date:** 2025-12-17
**Author:** Claude Opus 4.5 (Architect)
**Status:** Draft - CRITICAL - Awaiting Multi-Model Review
**Severity:** HIGH - Affects all user installations

---

## 1. Executive Summary

**Problem:** Ontos v2.x development has been heavily tested in "contributor mode" (Ontos developing itself) but has significant gaps in "user mode" (projects using Ontos). Several features don't work correctly or at all for regular users.

**Impact:** Any project that installs Ontos and runs `ontos_init.py` will have:
- Missing directory structure
- Broken consolidation (wrong paths)
- Missing starter files
- Features that silently fail

**Root Cause:** Dogfooding bias - we develop Ontos using Ontos, so contributor mode is continuously tested while user mode is not.

---

## 2. Mode Architecture Clarification

### 2.1 Two Orthogonal "Mode" Concepts

```
┌─────────────────────────────────────────────────────────────────┐
│              INSTALLATION MODE (who's using Ontos)              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  CONTRIBUTOR MODE                    USER MODE                  │
│  ─────────────────                   ─────────────              │
│  • Ontos developing itself           • Projects using Ontos    │
│  • Scans: .ontos-internal/           • Scans: docs/            │
│  • Detection: mission.md exists      • Detection: no mission.md│
│  • Users: Ontos maintainers          • Users: Everyone else    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│              WORKFLOW MODE (how much friction)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  AUTOMATED          PROMPTED           ADVISORY                 │
│  ──────────         ────────           ────────                 │
│  • Zero friction    • Keep me in loop  • Max flexibility       │
│  • Auto-archive     • Blocks push      • Warnings only         │
│  • Auto-consolidate • Agent reminders  • Manual everything     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

These are ORTHOGONAL:
• A USER can choose any WORKFLOW mode
• A CONTRIBUTOR can choose any WORKFLOW mode
```

### 2.2 Mode Detection

**Current implementation:** `is_ontos_repo()` in `ontos_config_defaults.py`

```python
def is_ontos_repo() -> bool:
    """Detect if we're in the Ontos repository (contributor mode)."""
    marker = os.path.join(PROJECT_ROOT, '.ontos-internal', 'kernel', 'mission.md')
    return os.path.exists(marker)
```

**This is correct** - the detection mechanism works. The problem is what happens AFTER detection.

---

## 3. Problem Statement

### 3.1 Installation Flow (Current - Broken)

```
User installs Ontos:
1. Copy .ontos/ directory to their project     ✅ Works
2. Copy ontos_init.py to their project         ✅ Works
3. Run: python3 ontos_init.py                  ⚠️  INCOMPLETE

What ontos_init.py SHOULD create:
docs/
├── logs/                          ✅ Created
├── strategy/                      ❌ NOT CREATED
│   ├── decision_history.md        ❌ NOT CREATED
│   └── proposals/                 ❌ NOT CREATED
├── archive/                       ❌ NOT CREATED
│   ├── logs/                      ❌ NOT CREATED
│   └── proposals/                 ❌ NOT CREATED
└── reference/
    └── Common_Concepts.md         ❌ NOT CREATED (only template copied)

Result: User runs consolidation → FAILS (no archive dir)
        User runs query → PARTIAL (no decision_history.md)
        User tries proposals → FAILS (no proposals dir)
```

### 3.2 Path Inconsistency

| File | Contributor Mode | User Mode (Current) | Problem |
|------|------------------|---------------------|---------|
| decision_history.md | `.ontos-internal/strategy/decision_history.md` | `docs/decision_history.md` | Different nesting! |
| proposals/ | `.ontos-internal/strategy/proposals/` | N/A | Doesn't exist |
| archive/logs/ | `.ontos-internal/archive/logs/` | `docs/archive/` | Missing subdirs |
| Common_Concepts.md | `.ontos-internal/reference/Common_Concepts.md` | `docs/reference/Common_Concepts.md` | Not created |

### 3.3 Affected Features

| Feature | Version | Contributor | User | Issue |
|---------|---------|-------------|------|-------|
| Consolidation | v2.1 | ✅ Works | ❌ Fails | No archive dir |
| decision_history.md | v2.1 | ✅ Works | ⚠️ Wrong path | Flat vs nested |
| Common_Concepts.md | v2.2 | ✅ Works | ❌ Not created | Scaffolding gap |
| --lint (concepts) | v2.2 | ✅ Works | ⚠️ Fails silently | No concepts file |
| ontos_query.py | v2.3 | ✅ Works | ⚠️ Partial | Missing files |
| ontos_consolidate.py | v2.3 | ✅ Works | ❌ Fails | Path issues |
| proposals/ | v2.5.1 | ✅ Works | ❌ Not created | Scaffolding gap |
| Rejection workflow | v2.6 | Planned | ❌ Will fail | No archive/proposals/ |

---

## 4. Root Cause Analysis

### 4.1 Dogfooding Bias

```
Development cycle:
1. Develop feature in Ontos repo (contributor mode)
2. Test by using feature (contributor mode)
3. Feature works! Ship it.
4. User installs Ontos (user mode)
5. Feature fails silently or crashes

We never step 4-5 because we're always in contributor mode.
```

### 4.2 Incremental Path Helper Growth

Path helpers were added incrementally without consistent structure:

```python
# Some helpers use nested structure
def get_decision_history_path():
    if is_ontos_repo():
        return '.ontos-internal/strategy/decision_history.md'  # Nested
    return 'docs/decision_history.md'  # FLAT - inconsistent!

# Some helpers are consistent
def get_logs_dir():
    if is_ontos_repo():
        return '.ontos-internal/logs'
    return 'docs/logs'  # Consistent!
```

### 4.3 Minimal Scaffolding Philosophy

`ontos_init.py` was designed to be minimal - create only what's immediately needed. But features added later expect directories that were never scaffolded.

---

## 5. Proposed Solution

### 5.1 Design Principle: Mirror Structure

**User mode should mirror contributor mode structure:**

```
CONTRIBUTOR MODE                    USER MODE
────────────────                    ─────────
.ontos-internal/                    docs/
├── kernel/                         ├── kernel/           (optional)
│   └── mission.md                  │   └── mission.md    (optional)
├── strategy/                       ├── strategy/
│   ├── decision_history.md         │   ├── decision_history.md
│   └── proposals/                  │   └── proposals/
├── atom/                           ├── atom/             (optional)
├── logs/                           ├── logs/
├── archive/                        ├── archive/
│   ├── logs/                       │   ├── logs/
│   └── proposals/                  │   └── proposals/
└── reference/                      └── reference/
    └── Common_Concepts.md              └── Common_Concepts.md
```

**Rationale:**
1. One mental model for documentation
2. Path helpers become simpler (just swap root)
3. All examples work for both modes
4. Future features automatically work

### 5.2 Scaffolding Changes

**File:** `ontos_init.py`

```python
def create_directory_structure():
    """Create complete Ontos directory structure for user mode."""

    docs_dir = resolve_config('DOCS_DIR', 'docs')

    # Required directories
    directories = [
        f'{docs_dir}/logs',
        f'{docs_dir}/strategy',
        f'{docs_dir}/strategy/proposals',
        f'{docs_dir}/archive',
        f'{docs_dir}/archive/logs',
        f'{docs_dir}/archive/proposals',
        f'{docs_dir}/reference',
    ]

    for directory in directories:
        path = os.path.join(PROJECT_ROOT, directory)
        if not os.path.exists(path):
            os.makedirs(path)
            print(f"   Created {directory}/")


def create_starter_files():
    """Create starter files for user mode."""

    docs_dir = resolve_config('DOCS_DIR', 'docs')

    # decision_history.md starter
    decision_history = os.path.join(PROJECT_ROOT, docs_dir, 'strategy', 'decision_history.md')
    if not os.path.exists(decision_history):
        with open(decision_history, 'w') as f:
            f.write(DECISION_HISTORY_TEMPLATE)
        print("   Created strategy/decision_history.md")

    # Common_Concepts.md starter
    concepts = os.path.join(PROJECT_ROOT, docs_dir, 'reference', 'Common_Concepts.md')
    if not os.path.exists(concepts):
        with open(concepts, 'w') as f:
            f.write(COMMON_CONCEPTS_TEMPLATE)
        print("   Created reference/Common_Concepts.md")
```

### 5.3 Path Helper Fixes

**File:** `.ontos/scripts/ontos_lib.py`

```python
def get_decision_history_path() -> str:
    """Get decision_history.md path (mode-aware)."""
    try:
        from ontos_config_defaults import PROJECT_ROOT, is_ontos_repo
    except ImportError:
        return 'docs/strategy/decision_history.md'

    if is_ontos_repo():
        return os.path.join(PROJECT_ROOT, '.ontos-internal', 'strategy', 'decision_history.md')

    docs_dir = resolve_config('DOCS_DIR', 'docs')
    return os.path.join(PROJECT_ROOT, docs_dir, 'strategy', 'decision_history.md')
    #                                           ^^^^^^^^^ FIXED: was flat, now nested


def get_proposals_dir() -> str:
    """Get proposals directory path (mode-aware). NEW HELPER."""
    try:
        from ontos_config_defaults import PROJECT_ROOT, is_ontos_repo
    except ImportError:
        return 'docs/strategy/proposals'

    if is_ontos_repo():
        return os.path.join(PROJECT_ROOT, '.ontos-internal', 'strategy', 'proposals')

    docs_dir = resolve_config('DOCS_DIR', 'docs')
    return os.path.join(PROJECT_ROOT, docs_dir, 'strategy', 'proposals')


def get_archive_proposals_dir() -> str:
    """Get archive/proposals directory path (mode-aware). NEW HELPER."""
    try:
        from ontos_config_defaults import PROJECT_ROOT, is_ontos_repo
    except ImportError:
        return 'docs/archive/proposals'

    if is_ontos_repo():
        return os.path.join(PROJECT_ROOT, '.ontos-internal', 'archive', 'proposals')

    docs_dir = resolve_config('DOCS_DIR', 'docs')
    return os.path.join(PROJECT_ROOT, docs_dir, 'archive', 'proposals')
```

### 5.4 Template Files

**DECISION_HISTORY_TEMPLATE:**
```markdown
---
id: decision_history
type: strategy
status: active
depends_on: []
---

# Decision History

This document records key decisions made during development, including both approvals and rejections.

## Decision Log

| Date | Slug | Decision | Outcome | Archive Path |
|------|------|----------|---------|--------------|
| | | | | |

## How to Use

- **Consolidation:** Old session logs are summarized here during monthly maintenance
- **Rejections:** Rejected proposals are recorded with REJECTED outcome
- **Historical Recall:** Reference archive paths to understand full context
```

**COMMON_CONCEPTS_TEMPLATE:**
```markdown
---
id: common_concepts
type: atom
status: active
depends_on: []
---

# Common Concepts

Controlled vocabulary for consistent tagging across session logs and documents.

## Concept Reference

| Concept | Description |
|---------|-------------|
| `architecture` | System design and structure |
| `bugfix` | Bug fixes and corrections |
| `config` | Configuration management |
| `docs` | Documentation |
| `feature` | New features |
| `performance` | Performance optimization |
| `refactor` | Code refactoring |
| `security` | Security concerns |
| `test` | Testing |
| `ux` | User experience |

## Adding New Concepts

Add new concepts as your project evolves. Keep descriptions brief (1 line).
```

---

## 6. Migration Strategy

### 6.1 New Installations

New users running `ontos_init.py` will get the complete structure automatically.

### 6.2 Existing User Installations

Users who installed Ontos before v2.5.2 need migration:

```bash
# Option A: Re-run init (safe - won't overwrite existing files)
python3 ontos_init.py

# Option B: Manual migration
mkdir -p docs/strategy/proposals
mkdir -p docs/archive/logs
mkdir -p docs/archive/proposals
mv docs/decision_history.md docs/strategy/decision_history.md  # If exists
```

**Migration script:** `ontos_migrate_structure.py`

```python
"""Migrate existing installations to v2.5.2 structure."""

def migrate():
    # Create missing directories
    create_directory_structure()

    # Move decision_history.md if in old location
    old_path = os.path.join(docs_dir, 'decision_history.md')
    new_path = os.path.join(docs_dir, 'strategy', 'decision_history.md')
    if os.path.exists(old_path) and not os.path.exists(new_path):
        shutil.move(old_path, new_path)
        print(f"   Moved decision_history.md to strategy/")

    # Create missing starter files
    create_starter_files()
```

### 6.3 Backward Compatibility

Path helpers should check both locations during transition:

```python
def get_decision_history_path() -> str:
    """Get decision_history.md path with backward compatibility."""
    # ... mode detection ...

    # Try new location first
    new_path = os.path.join(docs_dir, 'strategy', 'decision_history.md')
    if os.path.exists(new_path):
        return new_path

    # Fall back to old location
    old_path = os.path.join(docs_dir, 'decision_history.md')
    if os.path.exists(old_path):
        return old_path

    # Return new location for creation
    return new_path
```

---

## 7. Testing Strategy

### 7.1 User Mode Test Fixture

Create a test fixture that simulates user installation:

```python
@pytest.fixture
def user_mode_project(tmp_path):
    """Create a fresh user-mode Ontos installation."""

    # Copy .ontos/ scripts (simulates user copying from GitHub)
    shutil.copytree('.ontos', tmp_path / '.ontos')
    shutil.copy('ontos_init.py', tmp_path)

    # Run init (simulates user running ontos_init.py)
    subprocess.run([sys.executable, 'ontos_init.py', '--non-interactive'], cwd=tmp_path)

    # Verify structure was created
    assert (tmp_path / 'docs' / 'logs').exists()
    assert (tmp_path / 'docs' / 'strategy' / 'proposals').exists()
    assert (tmp_path / 'docs' / 'archive' / 'logs').exists()

    return tmp_path
```

### 7.2 Dual-Mode Test Decorator

```python
@pytest.mark.parametrize("mode", ["contributor", "user"])
def test_consolidation_works_in_both_modes(mode, tmp_path):
    """Consolidation should work identically in both modes."""

    if mode == "contributor":
        setup_contributor_mode(tmp_path)
    else:
        setup_user_mode(tmp_path)

    # Create some logs
    create_test_logs(tmp_path, count=20)

    # Run consolidation
    result = run_consolidation(tmp_path)

    # Verify
    assert result.returncode == 0
    assert archive_has_logs(tmp_path)
    assert decision_history_updated(tmp_path)
```

### 7.3 Test Coverage Requirements

| Feature | Contributor Test | User Test | Status |
|---------|------------------|-----------|--------|
| ontos_init.py scaffolding | N/A | Required | NEW |
| ontos_consolidate.py | Exists | Required | NEW |
| ontos_query.py | Exists | Required | NEW |
| ontos_end_session.py | Exists | Required | NEW |
| ontos_maintain.py | Exists | Required | NEW |
| Pre-commit hook | Exists | Required | NEW |
| Pre-push hook | Exists | Required | NEW |
| Context map generation | Exists | Required | NEW |
| Path helpers | Exists | Required | NEW |

---

## 8. Documentation Updates

### 8.1 Files to Update

| File | Change |
|------|--------|
| `docs/reference/Ontos_Manual.md` | Add directory structure section, clarify modes |
| `docs/reference/Ontos_Agent_Instructions.md` | Mode-agnostic examples |
| `README.md` | Clarify what gets created on init |
| `CONTRIBUTING.md` | Document dual-mode testing requirement |

### 8.2 Example Updates

**Before (contributor-mode assumption):**
```markdown
Decision history is stored in `.ontos-internal/strategy/decision_history.md`
```

**After (mode-agnostic):**
```markdown
Decision history is stored in:
- Contributor mode: `.ontos-internal/strategy/decision_history.md`
- User mode: `docs/strategy/decision_history.md`

The path is resolved automatically by Ontos scripts.
```

---

## 9. Implementation Checklist

### Phase 1: Critical Fixes (v2.5.2)

- [ ] Fix `ontos_init.py` to create complete directory structure
- [ ] Add `DECISION_HISTORY_TEMPLATE` to ontos_init.py
- [ ] Add `COMMON_CONCEPTS_TEMPLATE` to ontos_init.py
- [ ] Fix `get_decision_history_path()` - use nested structure
- [ ] Add `get_proposals_dir()` helper
- [ ] Add `get_archive_proposals_dir()` helper
- [ ] Add backward compatibility to path helpers
- [ ] Create `ontos_migrate_structure.py` script
- [ ] Update Manual with directory structure
- [ ] Update README with what init creates

### Phase 2: Testing (v2.5.2)

- [ ] Create user_mode_project test fixture
- [ ] Add user-mode tests for all major scripts
- [ ] Add dual-mode parametrized tests
- [ ] Run full test suite in user-mode fixture
- [ ] Document testing requirements in CONTRIBUTING.md

### Phase 3: Documentation (v2.5.2)

- [ ] Audit all docs for contributor-mode assumptions
- [ ] Update examples to be mode-agnostic
- [ ] Add "Directory Structure" section to Manual
- [ ] Add troubleshooting for "directory not found" errors

---

## 10. Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Breaking existing user installations | HIGH | Backward-compatible path helpers, migration script |
| Migration confusion | MEDIUM | Clear upgrade instructions, auto-migration in init |
| Test suite complexity | MEDIUM | Good fixtures, parametrized tests |
| Documentation drift | LOW | Mode-agnostic examples, review process |

---

## 11. Open Questions for Reviewers

### Q1: Nested vs Flat Structure for Users

**Question:** Should user mode mirror contributor mode exactly?

| Option | User Structure | Pros | Cons |
|--------|----------------|------|------|
| A: Mirror exactly | `docs/strategy/decision_history.md` | Consistent | More nesting |
| B: Simplified | `docs/decision_history.md` | Simpler | Inconsistent |

**Architect Recommendation:** Option A - consistency is worth the extra directory

### Q2: Auto-Migration Behavior

**Question:** Should `ontos_init.py` auto-migrate old installations?

| Option | Behavior |
|--------|----------|
| A: Auto-migrate silently | Move files, create dirs without asking |
| B: Auto-migrate with confirmation | Ask before moving files |
| C: Separate migration script | User must run `ontos_migrate_structure.py` |
| D: Detect and warn only | Tell user to run migration |

**Architect Recommendation:** Option B - be helpful but transparent

### Q3: Optional Directories

**Question:** Should all directories be created, or only required ones?

| Option | Created on Init |
|--------|-----------------|
| A: Everything | kernel/, strategy/, atom/, logs/, archive/, reference/ |
| B: Required only | logs/, strategy/, archive/, reference/ |
| C: Progressive | Create dirs when first needed |

**Architect Recommendation:** Option B - required dirs only, keeps it clean

### Q4: Test Infrastructure

**Question:** How should we ensure user-mode testing going forward?

| Option | Approach |
|--------|----------|
| A: CI runs tests twice | Once in contributor mode, once in user mode |
| B: Separate test files | `test_*_user.py` files |
| C: Parametrized tests | All tests run in both modes |
| D: Dedicated test project | Separate repo that uses Ontos |

**Architect Recommendation:** Option C - parametrized tests, single source of truth

### Q5: Error Messages

**Question:** When a directory is missing, should scripts auto-create or error?

| Option | Behavior |
|--------|----------|
| A: Auto-create silently | Create missing dirs as needed |
| B: Auto-create with message | Create and inform user |
| C: Error with instructions | Fail and tell user to run init |
| D: Configurable | Config option for behavior |

**Architect Recommendation:** Option B - helpful and transparent

---

## 12. Approval Checklist

| Reviewer | Status | Date | Notes |
|----------|--------|------|-------|
| Claude (Architect) | DRAFT | 2025-12-17 | Critical issues identified |
| Codex | PENDING | — | — |
| Gemini | PENDING | — | — |
| Human (Jonathan) | PENDING | — | — |

---

## 13. References

- [Session Log: Proposals Architecture](../logs/2025-12-17_v2-5-1-proposals-architecture.md)
- [V2.6 Proposals and Tooling](v2.6_proposals_and_tooling.md)
- [ontos_init.py](../../ontos_init.py)
- [ontos_lib.py](../../.ontos/scripts/ontos_lib.py)
